# VOS WASH Web App to Android APK Deployment Guide

This guide provides instructions for the Gemini agent in Android Studio to wrap the VOS WASH web application into a native Android app using a WebView.

**Objective:** Create a deployable APK that provides a seamless, app-like experience, including offline access, native PDF downloads to a specific folder, and system notifications upon download completion.

---

### Step 1: Project Setup in Android Studio

1.  **Create a New Project:**
    *   Open Android Studio and select "New Project".
    *   Choose the "Empty Views Activity" template.
    *   **Name:** `VOS WASH`
    *   **Package name:** `com.voswash.app`
    *   **Language:** `Kotlin`
    *   **Minimum SDK:** `API 24: Android 7.0 (Nougat)`

2.  **Add WebView to Layout:**
    *   Open `res/layout/activity_main.xml`.
    *   Replace the default `TextView` with a `WebView`.

    ```xml
    <?xml version="1.0" encoding="utf-8"?>
    <WebView xmlns:android="http://schemas.android.com/apk/res/android"
        xmlns:tools="http://schemas.android.com/tools"
        android:id="@+id/webview"
        android:layout_width="match_parent"
        android:layout_height="match_parent"
        tools:context=".MainActivity" />
    ```

3.  **Update Manifest for Permissions & Storage:**
    *   Open `AndroidManifest.xml`.
    *   Add permissions for internet, storage, and notifications **before** the `<application>` tag.
    *   Add `android:requestLegacyExternalStorage="true"` to the `<application>` tag to ensure file saving works on Android 10 and 11.

    ```xml
    <?xml version="1.0" encoding="utf-8"?>
    <manifest xmlns:android="http://schemas.android.com/apk/res/android"
        xmlns:tools="http://schemas.android.com/tools">

        <uses-permission android:name="android.permission.INTERNET" />
        <uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE" android:maxSdkVersion="28" />
        <uses-permission android:name="android.permission.POST_NOTIFICATIONS" />

        <application
            android:allowBackup="true"
            android:dataExtractionRules="@xml/data_extraction_rules"
            android:fullBackupContent="@xml/backup_rules"
            android:icon="@mipmap/ic_launcher"
            android:label="@string/app_name"
            android:roundIcon="@mipmap/ic_launcher_round"
            android:supportsRtl="true"
            android:requestLegacyExternalStorage="true"
            android:theme="@style/Theme.VOSWASH"
            tools:targetApi="31">
            <activity
                android:name=".MainActivity"
                android:exported="true">
                <intent-filter>
                    <action android:name="android.intent.action.MAIN" />
                    <category android:name="android.intent.category.LAUNCHER" />
                </intent-filter>
            </activity>
        </application>

    </manifest>
    ```

### Step 2: Configure the WebView

1.  **Asset Setup:**
    *   In the project view, right-click on the `app/` module -> `New` -> `Folder` -> `Assets Folder`.
    *   Copy all the web app files and folders (`index.html`, `index.tsx`, `components/`, etc.) into this newly created `assets` directory.

2.  **Load the Web App & Handle PDF Interception in `MainActivity.kt`:**
    *   Modify `MainActivity.kt` with the following code. This sets up the WebView, intercepts the special `data:application/pdf` URL, and handles native file saving and notifications.

    ```kotlin
    package com.voswash.app

    import android.annotation.SuppressLint
    import android.app.NotificationChannel
    import android.app.NotificationManager
    import android.content.Context
    import android.content.pm.PackageManager
    import android.os.Build
    import android.os.Bundle
    import android.os.Environment
    import android.util.Base64
    import android.webkit.WebView
    import android.webkit.WebViewClient
    import android.widget.Toast
    import androidx.activity.OnBackPressedCallback
    import androidx.appcompat.app.AppCompatActivity
    import androidx.core.app.ActivityCompat
    import androidx.core.app.NotificationCompat
    import androidx.core.app.NotificationManagerCompat
    import androidx.core.content.ContextCompat
    import java.io.File
    import java.io.FileOutputStream
    import java.text.SimpleDateFormat
    import java.util.Date
    import java.util.Locale

    class MainActivity : AppCompatActivity() {

        private val STORAGE_PERMISSION_CODE = 101
        private val NOTIFICATION_PERMISSION_CODE = 102
        private lateinit var webView: WebView

        @SuppressLint("SetJavaScriptEnabled")
        override fun onCreate(savedInstanceState: Bundle?) {
            super.onCreate(savedInstanceState)
            setContentView(R.layout.activity_main)
            
            checkPermissions()

            webView = findViewById(R.id.webview)

            // Configure WebView settings
            webView.settings.javaScriptEnabled = true
            webView.settings.domStorageEnabled = true // Crucial for localStorage
            webView.settings.allowFileAccess = true
            
            // Set a custom WebViewClient to intercept PDF downloads
            webView.webViewClient = object : WebViewClient() {
                override fun shouldOverrideUrlLoading(view: WebView?, url: String?): Boolean {
                    if (url != null && url.startsWith("data:application/pdf;base64,")) {
                        val base64Pdf = url.substring("data:application/pdf;base64,".length)
                        savePdfFromBase64(base64Pdf)
                        return true // Indicate we've handled the URL
                    }
                    return false // Let the WebView handle other URLs
                }
            }
            
            // Load the local HTML file from assets
            webView.loadUrl("file:///android_asset/index.html")
            
            // Handle back press using the modern dispatcher
            onBackPressedDispatcher.addCallback(this, object : OnBackPressedCallback(true) {
                override fun handleOnBackPressed() {
                    if (webView.canGoBack()) {
                        webView.goBack()
                    } else {
                        finish() 
                    }
                }
            })
        }

        private fun savePdfFromBase64(base64Pdf: String) {
            if (ContextCompat.checkSelfPermission(this, android.Manifest.permission.WRITE_EXTERNAL_STORAGE) != PackageManager.PERMISSION_GRANTED && Build.VERSION.SDK_INT <= Build.VERSION_CODES.P) {
                 Toast.makeText(this, "Storage permission is required to save PDFs.", Toast.LENGTH_LONG).show()
                 return
            }
            try {
                // Define the target folder in the public Documents directory
                val folder = File(Environment.getExternalStoragePublicDirectory(Environment.DIRECTORY_DOCUMENTS), "VOSWASH Invoices")
                if (!folder.exists()) {
                    folder.mkdirs()
                }

                // Create a unique filename
                val timeStamp = SimpleDateFormat("yyyyMMdd_HHmmss", Locale.getDefault()).format(Date())
                val fileName = "VOSWASH_Invoice_$timeStamp.pdf"
                val file = File(folder, fileName)

                // Decode Base64 and write to the file
                val pdfAsBytes = Base64.decode(base64Pdf, Base64.DEFAULT)
                FileOutputStream(file).use { os ->
                    os.write(pdfAsBytes)
                    os.flush()
                }

                val message = "Invoice saved in Documents/VOSWASH Invoices"
                Toast.makeText(this, message, Toast.LENGTH_LONG).show()
                showDownloadNotification("Download Complete", message)

            } catch (e: Exception) {
                e.printStackTrace()
                Toast.makeText(this, "Error saving PDF: ${e.message}", Toast.LENGTH_LONG).show()
            }
        }

        private fun showDownloadNotification(title: String, content: String) {
             if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.TIRAMISU &&
                ContextCompat.checkSelfPermission(this, android.Manifest.permission.POST_NOTIFICATIONS) != PackageManager.PERMISSION_GRANTED) {
                return // Don't show notification if permission is not granted
            }

            val channelId = "VOSWASH_DOWNLOAD_CHANNEL"
            val notificationId = 1
            
            if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O) {
                val name = "Download Notifications"
                val descriptionText = "Notifications for completed invoice downloads"
                val importance = NotificationManager.IMPORTANCE_DEFAULT
                val channel = NotificationChannel(channelId, name, importance).apply { description = descriptionText }
                val notificationManager: NotificationManager = getSystemService(Context.NOTIFICATION_SERVICE) as NotificationManager
                notificationManager.createNotificationChannel(channel)
            }

            val builder = NotificationCompat.Builder(this, channelId)
                .setSmallIcon(R.drawable.ic_launcher_foreground) // Use a default icon
                .setContentTitle(title)
                .setContentText(content)
                .setPriority(NotificationCompat.PRIORITY_DEFAULT)
                .setAutoCancel(true)

            with(NotificationManagerCompat.from(this)) {
                if (ActivityCompat.checkSelfPermission(this@MainActivity, android.Manifest.permission.POST_NOTIFICATIONS) != PackageManager.PERMISSION_GRANTED) {
                    return
                }
                notify(notificationId, builder.build())
            }
        }

        private fun checkPermissions() {
            // Storage permission for Android versions up to Pie (API 28)
            if (Build.VERSION.SDK_INT <= Build.VERSION_CODES.P) {
                if (ContextCompat.checkSelfPermission(this, android.Manifest.permission.WRITE_EXTERNAL_STORAGE) != PackageManager.PERMISSION_GRANTED) {
                    ActivityCompat.requestPermissions(this, arrayOf(android.Manifest.permission.WRITE_EXTERNAL_STORAGE), STORAGE_PERMISSION_CODE)
                }
            }
            // Notification permission for Android 13 (API 33) and above
            if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.TIRAMISU) {
                if (ContextCompat.checkSelfPermission(this, android.Manifest.permission.POST_NOTIFICATIONS) != PackageManager.PERMISSION_GRANTED) {
                    ActivityCompat.requestPermissions(this, arrayOf(android.Manifest.permission.POST_NOTIFICATIONS), NOTIFICATION_PERMISSION_CODE)
                }
            }
        }
    }
    ```

### Step 3: Final Checks and Build

1.  **App Icon:** Replace the default launcher icons in `res/mipmap-*` with the VOS WASH logo.
2.  **Theme:** Adjust the app theme in `res/values/themes.xml` to match the app's color scheme and ensure the status bar looks good. A no-action-bar theme is recommended.
3.  **Build APK:**
    *   Go to `Build` -> `Build Bundle(s) / APK(s)` -> `Build APK(s)`.
    *   Once the build is complete, Android Studio will show a notification with a "locate" link. Click this to find the generated APK file, which can be installed on an Android device.

---

This completes the process of wrapping the web application into a native Android APK with the required native features.