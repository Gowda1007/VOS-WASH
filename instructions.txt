# VOS WASH: Resilient Web App to Android APK Deployment Guide

**ATTENTION AGENT:** This is a stateful, resumable guide. It is broken into distinct phases. Each phase ends with a **Checkpoint**. If you are interrupted for any reason (timeout, quota, etc.), you can resume by checking the last completed checkpoint and continuing from the next phase.

**To Resume:** Check the project's file structure against the checkpoints below. Find the last successfully completed checkpoint and begin execution at the start of the next phase. If a checkpoint for a file fails because the file is incomplete, the instructions for that phase will guide you to delete and rewrite it.

---

### **Phase 1: Project Initialization**

**Goal:** Create the basic Android project structure.

1.  **Action:** Create a new Android Studio project with the following settings:
    *   Template: "Empty Views Activity"
    *   Name: `VOS WASH`
    *   Package name: `com.voswash.app`
    *   Language: `Kotlin`
    *   Minimum SDK: `API 24: Android 7.0 (Nougat)`
2.  **Action:** In the project view, right-click on the `app/` module -> `New` -> `Folder` -> `Assets Folder`. This will create `app/src/main/assets`.

**Checkpoint 1:** The folder `app/src/main/assets` exists. If it exists, Phase 1 is complete.

---

### **Phase 2: Web Asset Integration**

**Goal:** Copy the web application files into the Android project.

1.  **Action:** Copy all web application files (`index.html`, `index.tsx`, `metadata.json`, etc.) and folders (`components`, `hooks`, `services`) directly into the `app/src/main/assets` directory.

**Checkpoint 2:** The file `app/src/main/assets/index.html` exists. If it exists, Phase 2 is complete.

---

### **Phase 3: Android Manifest Configuration**

**Goal:** Configure app permissions and settings.

1.  **Action:** Open `app/src/main/AndroidManifest.xml`. Before writing, verify if it is complete by checking for the `<!-- END AndroidManifest.xml -->` marker. If the file exists but is incomplete, **DELETE IT**.
2.  **Action:** Create or overwrite `app/src/main/AndroidManifest.xml`.
3.  **Action:** Write the following line to the file first: `<!-- START AndroidManifest.xml -->`
4.  **Action:** Append the entire content below to the file.
5.  **Action:** Write the following line to the file last: `<!-- END AndroidManifest.xml -->`

    ```xml
    <?xml version="1.0" encoding="utf-8"?>
    <manifest xmlns:android="http://schemas.android.com/apk/res/android"
        xmlns:tools="http://schemas.android.com/tools">

        <uses-permission android:name="android.permission.INTERNET" />
        <uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE" android:maxSdkVersion="28" />
        <uses-permission android:name="android.permission.POST_NOTIFICATIONS" />

        <application
            android:allowBackup="true"
            android:dataExtractionRules="@xml/data_extraction_rules"
            android:fullBackupContent="@xml/backup_rules"
            android:icon="@mipmap/ic_launcher"
            android:label="@string/app_name"
            android:roundIcon="@mipmap/ic_launcher_round"
            android:supportsRtl="true"
            android:requestLegacyExternalStorage="true"
            android:theme="@style/Theme.VOSWASH"
            tools:targetApi="31">
            <activity
                android:name=".MainActivity"
                android:exported="true">
                <intent-filter>
                    <action android:name="android.intent.action.MAIN" />
                    <category android:name="android.intent.category.LAUNCHER" />
                </intent-filter>
            </activity>
        </application>
    </manifest>
    ```

**Checkpoint 3:** The file `app/src/main/AndroidManifest.xml` exists and contains BOTH `<!-- START AndroidManifest.xml -->` and `<!-- END AndroidManifest.xml -->`. If true, Phase 3 is complete.

---

### **Phase 4: Layout Configuration**

**Goal:** Set up the WebView as the main UI element.

1.  **Action:** Open `app/src/main/res/layout/activity_main.xml`. Before writing, verify if it is complete by checking for the `<!-- END activity_main.xml -->` marker. If the file exists but is incomplete, **DELETE IT**.
2.  **Action:** Create or overwrite `app/src/main/res/layout/activity_main.xml`.
3.  **Action:** Write the following line to the file first: `<!-- START activity_main.xml -->`
4.  **Action:** Append the entire content below to the file.
5.  **Action:** Write the following line to the file last: `<!-- END activity_main.xml -->`

    ```xml
    <?xml version="1.0" encoding="utf-8"?>
    <WebView xmlns:android="http://schemas.android.com/apk/res/android"
        xmlns:tools="http://schemas.android.com/tools"
        android:id="@+id/webview"
        android:layout_width="match_parent"
        android:layout_height="match_parent"
        tools:context=".MainActivity" />
    ```

**Checkpoint 4:** The file `app/src/main/res/layout/activity_main.xml` exists and contains BOTH `<!-- START activity_main.xml -->` and `<!-- END activity_main.xml -->`. If true, Phase 4 is complete.

---

### **Phase 5: MainActivity.kt Implementation**

**Goal:** Write the core logic in `MainActivity.kt`.

1.  **Action:** Open `app/src/main/java/com/voswash/app/MainActivity.kt`. Before writing, verify if it is complete by checking for the `// END MainActivity.kt` marker. If the file exists but is incomplete, **DELETE IT**.
2.  **Action:** Create or overwrite `app/src/main/java/com/voswash/app/MainActivity.kt`.
3.  **Action:** Write the following line to the file first: `// START MainActivity.kt`
4.  **Action:** Append the entire content below to the file.
5.  **Action:** Write the following line to the file last: `// END MainActivity.kt`

    ```kotlin
    package com.voswash.app

    import android.annotation.SuppressLint
    import android.app.NotificationChannel
    import android.app.NotificationManager
    import android.content.Context
    import android.content.pm.PackageManager
    import android.os.Build
    import android.os.Bundle
    import android.os.Environment
    import android.util.Base64
    import android.webkit.WebView
    import android.webkit.WebViewClient
    import android.widget.Toast
    import androidx.activity.OnBackPressedCallback
    import androidx.appcompat.app.AppCompatActivity
    import androidx.core.app.ActivityCompat
    import androidx.core.app.NotificationCompat
    import androidx.core.app.NotificationManagerCompat
    import androidx.core.content.ContextCompat
    import java.io.File
    import java.io.FileOutputStream
    import java.text.SimpleDateFormat
    import java.util.Date
    import java.util.Locale

    class MainActivity : AppCompatActivity() {

        private val STORAGE_PERMISSION_CODE = 101
        private val NOTIFICATION_PERMISSION_CODE = 102
        private lateinit var webView: WebView

        @SuppressLint("SetJavaScriptEnabled")
        override fun onCreate(savedInstanceState: Bundle?) {
            super.onCreate(savedInstanceState)
            setContentView(R.layout.activity_main)
            
            checkPermissions()

            webView = findViewById(R.id.webview)

            webView.settings.javaScriptEnabled = true
            webView.settings.domStorageEnabled = true
            webView.settings.allowFileAccess = true
            
            webView.webViewClient = object : WebViewClient() {
                override fun shouldOverrideUrlLoading(view: WebView?, url: String?): Boolean {
                    if (url != null && url.startsWith("data:application/pdf;base64,")) {
                        val base64Pdf = url.substring("data:application/pdf;base64,".length)
                        savePdfFromBase64(base64Pdf)
                        return true
                    }
                    return false
                }
            }
            
            webView.loadUrl("file:///android_asset/index.html")
            
            onBackPressedDispatcher.addCallback(this, object : OnBackPressedCallback(true) {
                override fun handleOnBackPressed() {
                    if (webView.canGoBack()) {
                        webView.goBack()
                    } else {
                        finish() 
                    }
                }
            })
        }

        private fun savePdfFromBase64(base64Pdf: String) {
            if (Build.VERSION.SDK_INT <= Build.VERSION_CODES.P && ContextCompat.checkSelfPermission(this, android.Manifest.permission.WRITE_EXTERNAL_STORAGE) != PackageManager.PERMISSION_GRANTED) {
                 Toast.makeText(this, "Storage permission is required to save PDFs.", Toast.LENGTH_LONG).show()
                 return
            }
            try {
                val folder = File(Environment.getExternalStoragePublicDirectory(Environment.DIRECTORY_DOCUMENTS), "VOSWASH Invoices")
                if (!folder.exists()) {
                    folder.mkdirs()
                }

                val timeStamp = SimpleDateFormat("yyyyMMdd_HHmmss", Locale.getDefault()).format(Date())
                val fileName = "VOSWASH_Invoice_$timeStamp.pdf"
                val file = File(folder, fileName)

                val pdfAsBytes = Base64.decode(base64Pdf, Base64.DEFAULT)
                FileOutputStream(file).use { os ->
                    os.write(pdfAsBytes)
                    os.flush()
                }

                val message = "Invoice saved in Documents/VOSWASH Invoices"
                Toast.makeText(this, message, Toast.LENGTH_LONG).show()
                showDownloadNotification("Download Complete", message)

            } catch (e: Exception) {
                e.printStackTrace()
                Toast.makeText(this, "Error saving PDF: ${e.message}", Toast.LENGTH_LONG).show()
            }
        }

        private fun showDownloadNotification(title: String, content: String) {
             if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.TIRAMISU && ContextCompat.checkSelfPermission(this, android.Manifest.permission.POST_NOTIFICATIONS) != PackageManager.PERMISSION_GRANTED) {
                return
            }

            val channelId = "VOSWASH_DOWNLOAD_CHANNEL"
            val notificationId = 1
            
            if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O) {
                val name = "Download Notifications"
                val descriptionText = "Notifications for completed invoice downloads"
                val importance = NotificationManager.IMPORTANCE_DEFAULT
                val channel = NotificationChannel(channelId, name, importance).apply { description = descriptionText }
                val notificationManager: NotificationManager = getSystemService(Context.NOTIFICATION_SERVICE) as NotificationManager
                notificationManager.createNotificationChannel(channel)
            }

            val builder = NotificationCompat.Builder(this, channelId)
                .setSmallIcon(R.drawable.ic_launcher_foreground)
                .setContentTitle(title)
                .setContentText(content)
                .setPriority(NotificationCompat.PRIORITY_DEFAULT)
                .setAutoCancel(true)

            with(NotificationManagerCompat.from(this)) {
                if (ActivityCompat.checkSelfPermission(this@MainActivity, android.Manifest.permission.POST_NOTIFICATIONS) != PackageManager.PERMISSION_GRANTED) {
                    return
                }
                notify(notificationId, builder.build())
            }
        }

        private fun checkPermissions() {
            if (Build.VERSION.SDK_INT <= Build.VERSION_CODES.P) {
                if (ContextCompat.checkSelfPermission(this, android.Manifest.permission.WRITE_EXTERNAL_STORAGE) != PackageManager.PERMISSION_GRANTED) {
                    ActivityCompat.requestPermissions(this, arrayOf(android.Manifest.permission.WRITE_EXTERNAL_STORAGE), STORAGE_PERMISSION_CODE)
                }
            }
            if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.TIRAMISU) {
                if (ContextCompat.checkSelfPermission(this, android.Manifest.permission.POST_NOTIFICATIONS) != PackageManager.PERMISSION_GRANTED) {
                    ActivityCompat.requestPermissions(this, arrayOf(android.Manifest.permission.POST_NOTIFICATIONS), NOTIFICATION_PERMISSION_CODE)
                }
            }
        }
    }
    ```
**Checkpoint 5:** The file `app/src/main/java/com/voswash/app/MainActivity.kt` exists and contains BOTH `// START MainActivity.kt` and `// END MainActivity.kt`. If true, Phase 5 is complete.

---

### **Phase 6: Final Build**

**Goal:** Compile the app into a shareable APK.

1.  **Action:** From the Android Studio menu, go to `Build` -> `Build Bundle(s) / APK(s)` -> `Build APK(s)`.
2.  **Action:** Wait for the build to complete. A notification will appear.
3.  **Action:** Click the "locate" link in the notification to find the generated `app-debug.apk` file.

**Checkpoint 6:** The file `app/build/outputs/apk/debug/app-debug.apk` exists. If it exists, the process is complete.

---

### **Phase 7: Cleanup**

**Goal:** Remove this instruction file.

1.  **Action:** Delete this `instructions.txt` file from the project.
2.  **Report Completion:** Inform the user that the APK has been successfully built.

---
END OF INSTRUCTIONS
---